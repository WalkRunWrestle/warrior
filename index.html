<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Warrior Half Marathon ‚ö°</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{
    --bg:#070711;
    --panel:#0e0f1c;
    --panel2:#0b0c16;
    --border:#25263a;
    --text:#ffffff;
    --muted:rgba(255,255,255,.74);
    --accent:#a3ff12;   /* neon */
    --accent2:#7c3aed;  /* purple */
    --secondary:#27272a;
    --danger:#7f1d1d;
    --green:#22c55e;
  }


  /* =========================
     RUN PAGE COLOR MODES
     Only affects the logging page (#run)
  ========================= */

  /* Standard (earthy + muted neon) */
  #run{
    --bg:#06070b;
    --panel:#0c0f12;
    --panel2:#0a0c10;
    --border:rgba(255,255,255,0.12);
    --text:#ffffff;
    --muted:rgba(255,255,255,.74);

    /* muted ‚Äúwarrior‚Äù palette (pinks + greens but calmer) */
    --accent:#ec4899;   /* pink */
    --green:#34d399;    /* mint */
    --secondary:#1f2937;
  }

  /* Warrior mode (neon + glow) */
  #run.warriorMode{
    --bg:#030014;
    --panel:#070026;
    --panel2:#06001e;
    --border:rgba(255,255,255,0.18);

    --accent:#ff00c8;   /* neon magenta */
    --green:#00ff8a;    /* neon green */
    --secondary:#111827;
  }

  /* Extra glow / hype only on the run page */
  #run.warriorMode .topTitle,
  #run.warriorMode .helloPill{
    text-shadow:
      0 0 10px rgba(255,0,200,.65),
      0 0 22px rgba(0,255,138,.35);
  }

  #run.warriorMode .progressCard,
  #run.warriorMode .controlsCard,
  #run.warriorMode #map,
  #run.warriorMode .pill,
  #run.warriorMode .helloPill{
    box-shadow:
      0 0 0 1px rgba(255,0,200,.22) inset,
      0 0 24px rgba(255,0,200,.22),
      0 0 30px rgba(0,255,138,.12);
  }

  #run.warriorMode .barFill{
    box-shadow: 0 0 16px rgba(0,255,138,.55);
  }

  #run.warriorMode button{
    box-shadow:
      0 0 0 1px rgba(255,0,200,.22) inset,
      0 0 18px rgba(255,0,200,.25);
  }

  #run.warriorMode .mapCtrlBtn{
    box-shadow:
      0 0 0 1px rgba(0,255,138,.18) inset,
      0 0 16px rgba(0,255,138,.18);
  }

  *{ box-sizing:border-box; }
  body { margin:0; font-family:Inter, Arial, sans-serif; background:radial-gradient(1200px 600px at 50% -10%, rgba(124,58,237,.24), transparent 55%),
                                   radial-gradient(900px 520px at 20% 10%, rgba(163,255,18,.12), transparent 60%),
                                   var(--bg);
         color:var(--text); }
  section { width:100%; min-height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:16px 0; }

  button { padding:14px 18px; font-size:16px; background:var(--accent2); color:white; border:none; border-radius:14px; cursor:pointer; font-weight:900; }
  button:disabled{ opacity:.45; cursor:not-allowed; }
  input { padding:12px; font-size:16px; border-radius:14px; border:1px solid #333; background:rgba(10,10,20,.75); color:var(--text); width:100%; }

  .panel { padding:12px; width:92vw; max-width:900px; }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:7px 10px; border-radius:999px;
    border:1px solid var(--border);
    background:rgba(255,255,255,0.04);
    font-size:12px; font-weight:800; white-space:nowrap;
  }
  .pillBtn{
    background:transparent;
    border:1px solid var(--border);
    color:var(--text);
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:900;
    cursor:pointer;
  }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  /* Spotify banner */
  .spotifyTopBar{
    width:min(92vw, 520px);
    margin:10px auto 0;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    padding:10px 12px;
    border-radius:16px;
    border:1px solid rgba(163,255,18,.25);
    background:linear-gradient(90deg, rgba(124,58,237,.20), rgba(163,255,18,.12));
    box-shadow:0 0 0 2px rgba(163,255,18,.06) inset, 0 18px 60px rgba(0,0,0,.35);
    text-align:left;
  }
  .spotifyTopText{
    font-size:12px;
    font-weight:900;
    line-height:1.2;
    color:rgba(255,255,255,.9);
  }
  .spotifyTopBtn{
    padding:10px 12px;
    border-radius:14px;
    background:rgba(0,0,0,.2);
    border:1px solid rgba(255,255,255,.16);
    font-size:12px;
    font-weight:900;
    white-space:nowrap;
  }

  /* Toast */
  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:18px;
    background:rgba(12,12,22,.92);
    border:1px solid var(--border);
    padding:10px 12px;
    border-radius:14px;
    opacity:0;
    pointer-events:none;
    transition:opacity .18s ease;
    z-index:99999;
    width:min(88vw, 520px);
    text-align:center;
    font-size:14px;
  }
  .toast.show{ opacity:1; }

  /* Login */
  .loginCard{
    width:min(92vw, 420px);
    background:rgba(255,255,255,0.04);
    border:1px solid var(--border);
    border-radius:18px;
    padding:18px 16px;
    box-shadow:0 18px 60px rgba(0,0,0,0.55);
    text-align:left;
    backdrop-filter: blur(10px);
  }
  .loginTitle{ font-size:26px; font-weight:900; margin:0; text-align:center; }
  .loginSub{ margin:8px 0 10px; opacity:.85; font-size:13px; text-align:center; }
  .fieldWrap{ position:relative; width:100%; }
  .pwToggle{
    position:absolute; right:10px; top:50%; transform:translateY(-50%);
    background:transparent; border:1px solid var(--border);
    color:var(--text); padding:6px 10px; border-radius:10px;
    font-size:12px; cursor:pointer; opacity:.9;
  }
  .warnLine{ margin-top:8px; opacity:.9; font-size:12px; text-align:center; }
  .warnLine b{ color:#d4ffb3; }
  .helpLine{ margin-top:10px; opacity:.75; font-size:12px; text-align:center; }

  /* Splash */
  .splashWrap{ width:min(92vw, 560px); display:flex; flex-direction:column; align-items:center; gap:10px; }
  .brandTitle{ font-size:30px; font-weight:900; letter-spacing:.3px; }
  .brandTag{ font-size:14px; opacity:.85; }
  .welcomeLine{ font-size:40px; font-weight:900; margin-top:2px; line-height:1.05; }
  .nextLine{ font-size:13px; opacity:.82; margin-top:0; }
  .progressLine{ margin-top:0; font-size:16px; font-weight:900; opacity:.95; }
  .splashBtn{ width:min(320px, 78vw); padding:16px 18px; font-size:18px; border-radius:16px; background:var(--accent2); }
  .whoRow{ width:92vw; max-width:900px; margin-top:6px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap; align-items:center; }

  /* Run header */
  .topBar{ width:92vw; max-width:900px; margin-top:4px; display:flex; flex-direction:column; align-items:center; gap:6px; }
  .topTitle{ font-size:28px; font-weight:900; letter-spacing:.2px; line-height:1.05; }
  .topSub{ font-size:13px; color:var(--muted); letter-spacing:.2px; }

  /* Progress card */
  .progressCard{
    width:92vw; max-width:900px;
    margin-top:12px;
    background:rgba(255,255,255,0.04);
    border:1px solid var(--border);
    border-radius:18px;
    padding:12px 14px;
    text-align:left;
    backdrop-filter: blur(10px);
  }
  .progressTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .progressLabel{ font-size:13px; color:var(--muted); font-weight:700; }
  .progressValue{ font-size:16px; font-weight:900; letter-spacing:.2px; }

  .bar{
    width:100%; height:10px; border-radius:999px;
    background:rgba(255,255,255,0.08);
    border:1px solid var(--border);
    overflow:hidden; margin-top:10px;
  }
  .barFill{
    height:100%; width:0%;
    background:linear-gradient(90deg, var(--accent), rgba(124,58,237,.95));
    border-radius:999px;
    transition:width .35s ease;
  }
  .subRow{
    margin-top:10px;
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; flex-wrap:wrap;
  }
  .savedPill{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px;
    border:1px solid var(--border);
    background:var(--panel2);
    font-size:12px;
    opacity:0;
    transform:translateY(-2px);
    transition:opacity .18s ease, transform .18s ease;
  }
  .savedPill.show{ opacity:1; transform:translateY(0px); }
  .lastUpdate{ font-size:12px; color:var(--muted); font-weight:700; }

  /* Map */
  #mapWrap{ width:92vw; max-width:900px; margin-top:10px; position:relative; }
  #map {
    height:56vh;
    width:100%;
    border:2px solid rgba(163,255,18,.45);
    border-radius:18px;
    overflow:hidden;
    background:#0b0b10;
  }
  #map.map-locked{ touch-action: pan-y !important; }
  #map.map-unlocked{ touch-action: none !important; }
  .mapControls{
    position:absolute;
    right:10px;
    bottom:10px;
    display:flex;
    flex-direction:column;
    gap:8px;
    z-index:1000;
  }
  .mapCtrlBtn{
    background:rgba(10,10,20,0.85);
    border:1px solid var(--border);
    color:var(--text);
    padding:10px 12px;
    border-radius:14px;
    font-size:13px;
    font-weight:900;
    cursor:pointer;
    backdrop-filter: blur(6px);
  }
  .mapLoading{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    background:rgba(7,7,17,.88);
    border-radius:18px;
    z-index:999;
    padding:14px;
  }
  .mapLoadingCard{
    background:rgba(255,255,255,0.05);
    border:1px solid var(--border);
    padding:12px 14px;
    border-radius:14px;
    font-size:13px;
    color:var(--muted);
    width:min(84vw, 420px);
    text-align:center;
  }
  .leaflet-div-icon{ background:transparent !important; border:none !important; }

  /* Controls */
  .controlsCard{
    width:92vw; max-width:900px;
    margin-top:12px;
    background:rgba(255,255,255,0.04);
    border:1px solid var(--border);
    border-radius:18px;
    padding:12px 14px;
    backdrop-filter: blur(10px);
  }
  .btnRow{ display:flex; gap:10px; justify-content:center; flex-wrap:nowrap; }
  .quickBtn{
    padding:12px 10px; border-radius:16px; font-size:16px; font-weight:900;
    margin:0; flex:1 1 0; min-width:0; max-width:220px; white-space:nowrap;
    background:rgba(163,255,18,.15);
    border:1px solid rgba(163,255,18,.30);
  }
  .inputRow{ display:flex; gap:10px; justify-content:center; align-items:center; margin-top:10px; flex-wrap:nowrap; }
  .kmInput{ width:240px; max-width:48vw; margin:0; }
  .addBtn{ padding:12px 16px; margin:0; border-radius:16px; font-weight:900; white-space:nowrap; background:var(--accent2); }
  .bottomRow{ display:flex; justify-content:space-between; gap:10px; align-items:center; margin-top:10px; flex-wrap:nowrap; }
  .ghostBtn{
    background:rgba(255,255,255,0.08);
    border:1px solid var(--border);
    margin:0; padding:12px 14px; border-radius:16px;
    font-weight:900; flex:1 1 0; color:var(--text);
  }

  /* Overlay + modal card (required for finish popup) */
  .overlay{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
    background:rgba(0,0,0,.66);
    backdrop-filter: blur(6px);
    z-index:99999;
  }
  .card{
    width:min(92vw, 520px);
    background:rgba(255,255,255,0.05);
    border:1px solid var(--border);
    border-radius:20px;
    box-shadow:0 22px 70px rgba(0,0,0,.65);
    backdrop-filter: blur(12px);
  }

  /* Finish (tidied) */
  .finishCard{
    text-align:center;
    padding:18px 16px;
  }
  .finishTop{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    margin-bottom:6px;
  }
  .finishIcon{
    width:44px; height:44px;
    display:grid; place-items:center;
    border-radius:14px;
    border:1px solid var(--border);
    background:rgba(255,255,255,0.04);
    font-size:22px;
    box-shadow:0 0 0 2px rgba(255,255,255,0.02) inset;
  }
  .finishTitle{
    margin:0;
    font-size:34px;
    font-weight:900;
    letter-spacing:.2px;
    line-height:1.05;
  }
  .finishSub{
    margin:8px 0 0;
    opacity:.9;
    font-size:14px;
    line-height:1.45;
  }
  .finishStats{
    margin-top:12px;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    justify-content:center;
  }
  .statPill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:rgba(255,255,255,0.03);
    font-size:12px;
    font-weight:800;
    white-space:nowrap;
  }
  .finishNext{
    margin-top:14px;
    text-align:left;
    border:1px solid var(--border);
    background:rgba(255,255,255,0.03);
    border-radius:16px;
    padding:12px 12px;
  }
  .finishNextTitle{
    font-weight:900;
    font-size:13px;
    letter-spacing:.2px;
    margin:0 0 8px 0;
  }
  .finishSteps{
    margin:0;
    padding-left:18px;
    color:var(--muted);
    font-size:13px;
    line-height:1.45;
  }
  .finishSteps b{ color:var(--text); }
  .finishHelp{
    margin-top:12px;
    text-align:left;
    border:1px solid var(--border);
    border-radius:16px;
    background:rgba(255,255,255,0.02);
    overflow:hidden;
  }
  .finishHelp summary{
    list-style:none;
    cursor:pointer;
    padding:12px 12px;
    font-weight:900;
    font-size:13px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .finishHelp summary::-webkit-details-marker{ display:none; }
  .finishHelp summary:after{
    content:"‚ñæ";
    opacity:.8;
  }
  .finishHelp[open] summary:after{ content:"‚ñ¥"; }
  .finishHelpBody{
    padding:0 12px 12px 12px;
    color:var(--muted);
    font-size:13px;
    line-height:1.45;
  }
  .copyRow{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
    margin:10px 0 6px;
    padding:10px 10px;
    border-radius:14px;
    border:1px solid var(--border);
    background:rgba(0,0,0,0.15);
  }
  .emailMono{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-weight:900;
    color:var(--text);
    font-size:13px;
    word-break:break-all;
  }
  .copyBtn{
    padding:10px 12px;
    border-radius:14px;
    border:1px solid var(--border);
    background:var(--secondary);
    color:var(--text);
    font-weight:900;
    font-size:12px;
    cursor:pointer;
  }
  .finishButtons{
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
    margin-top:14px;
  }
  .primaryBtn{ background:var(--accent); flex:1 1 220px; }
  .secondaryBtn{ background:var(--secondary); flex:1 1 160px; }
/* ===== Warrior toggle (RUN page only) ===== */
  /* Softer "basic" palette just for the logging page */
  #run{
    --bg:#070a10;
    --panel:#0e1320;
    --panel2:#0b1220;
    --border:#273046;
    --text:#ffffff;
    --muted:rgba(255,255,255,.75);
    --accent:#ff4fa3;      /* pink */
    --green:#38d16a;       /* punchy green */
    --secondary:#1f2937;
    --danger:#7f1d1d;
  }

  /* Warrior mode overrides (neon + glow) */
  #run.warriorMode{
    --bg:#05020d;
    --panel:#0b0520;
    --panel2:#08021a;
    --border:#3b1a66;
    --text:#ffffff;
    --muted:rgba(255,255,255,.78);
    --accent:#ff2dff;      /* magenta neon */
    --green:#22ff88;       /* neon green */
    --secondary:#141026;
  }

  /* Add a subtle animated aura only in warrior mode */
  #run.warriorMode .progressCard,
  #run.warriorMode .controlsCard,
  #run.warriorMode #map{
    box-shadow: 0 0 0 1px rgba(255,45,255,.25), 0 0 22px rgba(255,45,255,.18), 0 0 40px rgba(34,255,136,.10);
  }
  #run.warriorMode button,
  #run.warriorMode .pillBtn{
    box-shadow: 0 0 16px rgba(255,45,255,.25), 0 0 26px rgba(34,255,136,.12);
  }
  #run.warriorMode .barFill{
    filter: drop-shadow(0 0 10px rgba(34,255,136,.45));
  }

  /* Toggle UI */
  .modeToggleWrap{
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding:7px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:rgba(255,255,255,0.03);
    white-space:nowrap;
  }
  .modeLabel{
    font-size:12px;
    font-weight:900;
    letter-spacing:.3px;
    opacity:.95;
  }
  .modeHint{
    font-size:11px;
    opacity:.72;
    margin-left:2px;
  }
  .switch{
    position:relative;
    width:52px;
    height:28px;
    border-radius:999px;
    border:1px solid var(--border);
    background:rgba(255,255,255,0.06);
    cursor:pointer;
    flex:0 0 auto;
    transition:transform .12s ease;
  }
  /* tiny "wriggle" */
  .switch:active{ transform: rotate(-2deg) scale(0.98); }
  .knob{
    position:absolute;
    top:3px; left:3px;
    width:22px; height:22px;
    border-radius:999px;
    background:var(--accent);
    box-shadow: 0 6px 16px rgba(0,0,0,.35);
    transition:left .18s ease, filter .18s ease, background .18s ease;
  }
  #run.warriorMode .knob{
    background:linear-gradient(135deg, var(--accent), var(--green));
    filter: drop-shadow(0 0 10px rgba(255,45,255,.55));
  }
  .switch.on .knob{ left:27px; }


/* ===== WARRIOR MODE NEON OVERRIDE ===== */
#run.warriorMode{
  background:
    radial-gradient(circle at top, rgba(255,0,180,0.25), transparent 40%),
    radial-gradient(circle at bottom, rgba(0,255,170,0.25), transparent 45%),
    linear-gradient(180deg,#050007,#090015,#050007);
  animation: warriorPulse 4s ease-in-out infinite;
}

@keyframes warriorPulse{
  0%{filter:brightness(1) saturate(1.2);}
  50%{filter:brightness(1.25) saturate(1.8);}
  100%{filter:brightness(1) saturate(1.2);}
}

#run.warriorMode h1,
#run.warriorMode h2,
#run.warriorMode h3{
  color:#ff2bdc;
  text-shadow:
    0 0 6px #ff2bdc,
    0 0 14px #ff2bdc,
    0 0 28px rgba(255,43,220,0.9);
}

#run.warriorMode button{
  background:linear-gradient(135deg,#ff2bdc,#00ffae);
  color:#000;
  border:none;
  box-shadow:
    0 0 10px rgba(255,43,220,0.9),
    0 0 25px rgba(0,255,174,0.8),
    inset 0 0 8px rgba(255,255,255,0.4);
  transform:scale(1.02);
}

#run.warriorMode button:hover{
  transform:scale(1.08) rotate(-1deg);
  box-shadow:
    0 0 18px rgba(255,43,220,1),
    0 0 45px rgba(0,255,174,1);
}

#run.warriorMode input{
  background:#020003;
  border:2px solid #ff2bdc;
  color:#00ffae;
  box-shadow:
    0 0 10px rgba(255,43,220,0.6),
    inset 0 0 8px rgba(0,255,174,0.5);
}

#run.warriorMode #mapWrap{
  box-shadow:
    0 0 25px rgba(255,43,220,0.7),
    0 0 60px rgba(0,255,174,0.6);
  border:2px solid #ff2bdc;
}

/* Neon progress line */
.leaflet-overlay-pane path{
  transition:stroke 0.4s, filter 0.4s;
}
#run.warriorMode .leaflet-overlay-pane path{
  filter:
    drop-shadow(0 0 6px rgba(0,255,174,0.9))
    drop-shadow(0 0 14px rgba(0,255,174,0.7));
}

/* =========================
   ULTRA WARRIOR MODE (CRANKED)
   - only affects logging page
   - map tiles stay readable (we don't recolor the tiles)
========================= */
#run.warriorMode{
  /* insane neon background */
  background:
    radial-gradient(circle at 15% 10%, rgba(255, 0, 200, .35), transparent 42%),
    radial-gradient(circle at 85% 20%, rgba(0, 255, 175, .28), transparent 45%),
    radial-gradient(circle at 60% 90%, rgba(255, 255, 0, .16), transparent 50%),
    linear-gradient(180deg, #03000a 0%, #060015 40%, #03000a 100%);
  animation: wmPulse 2.8s ease-in-out infinite;
  position:relative;
  overflow:hidden;
}
@keyframes wmPulse{
  0%{ filter: brightness(1.05) saturate(1.7); }
  50%{ filter: brightness(1.45) saturate(2.6); }
  100%{ filter: brightness(1.05) saturate(1.7); }
}
/* flying neon grain */
#run.warriorMode::before{
  content:"";
  position:absolute; inset:-40%;
  background:
    repeating-linear-gradient(115deg,
      rgba(255,45,255,.08) 0px,
      rgba(255,45,255,.08) 2px,
      rgba(0,255,174,.05) 2px,
      rgba(0,255,174,.05) 6px,
      transparent 6px,
      transparent 14px);
  transform: rotate(8deg);
  animation: wmScan 6s linear infinite;
  pointer-events:none;
  mix-blend-mode: screen;
}
@keyframes wmScan{
  from{ transform: translate3d(-4%, -2%, 0) rotate(8deg); }
  to  { transform: translate3d(4%, 2%, 0) rotate(8deg); }
}
#run.warriorMode::after{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(circle at 50% 50%, rgba(255,255,255,.06), transparent 55%);
  pointer-events:none;
}

/* Headings and key text */
#run.warriorMode .topTitle{
  color:#ffffff;
  text-shadow:
    0 0 6px rgba(255,45,255,1),
    0 0 18px rgba(255,45,255,.9),
    0 0 28px rgba(0,255,174,.65);
  letter-spacing:.6px;
}

/* Cards become neon glass */
#run.warriorMode .progressCard,
#run.warriorMode .controlsCard{
  background: rgba(0,0,0,.35);
  border: 1px solid rgba(255,45,255,.35);
  box-shadow:
    0 0 0 2px rgba(0,255,174,.10) inset,
    0 0 18px rgba(255,45,255,.55),
    0 0 50px rgba(0,255,174,.18);
}

/* Spotify banner: louder */
#run.warriorMode .spotifyTopBar{
  border: 1px solid rgba(0,255,174,.45);
  background: linear-gradient(90deg, rgba(255,45,255,.28), rgba(0,255,174,.18));
  box-shadow:
    0 0 0 2px rgba(255,255,255,.05) inset,
    0 0 26px rgba(255,45,255,.35),
    0 0 44px rgba(0,255,174,.22);
}
#run.warriorMode .spotifyTopBtn{
  background: linear-gradient(135deg, rgba(255,45,255,.95), rgba(0,255,174,.85));
  color:#020003;
  border: none;
  box-shadow:
    0 0 14px rgba(255,45,255,.9),
    0 0 26px rgba(0,255,174,.7);
}

/* Map container: neon frame only (tiles unchanged) */
#run.warriorMode #map{
  border: 2px solid rgba(0,255,174,.55);
  box-shadow:
    0 0 0 2px rgba(255,45,255,.10) inset,
    0 0 28px rgba(0,255,174,.35),
    0 0 60px rgba(255,45,255,.18);
}

/* Map controls: neon candy buttons */
#run.warriorMode .mapCtrlBtn{
  background: rgba(0,0,0,.38);
  border: 1px solid rgba(0,255,174,.30);
  box-shadow:
    0 0 0 1px rgba(255,45,255,.16) inset,
    0 0 18px rgba(0,255,174,.22),
    0 0 22px rgba(255,45,255,.14);
}

/* Progress bar: ridiculous glow */
#run.warriorMode .bar{
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(0,255,174,.25);
}
#run.warriorMode .barFill{
  background: linear-gradient(90deg, #00ffae, #ff2dff, #ffe600);
  box-shadow:
    0 0 14px rgba(0,255,174,.85),
    0 0 28px rgba(255,45,255,.65);
}

/* QUICK BUTTONS: each a different neon color (except map) */
#run.warriorMode .quickBtn{
  color:#050007;
  border:none;
  box-shadow:
    0 0 12px rgba(255,255,255,.15) inset,
    0 0 18px rgba(255,45,255,.35),
    0 0 26px rgba(0,255,174,.22);
  transform: translateZ(0);
}
#run.warriorMode .quickBtn:nth-child(1){
  background: linear-gradient(135deg, #00ffae, #00d4ff);
  box-shadow: 0 0 18px rgba(0,255,174,.85), 0 0 22px rgba(0,212,255,.6);
}
#run.warriorMode .quickBtn:nth-child(2){
  background: linear-gradient(135deg, #ff2dff, #ff0066);
  box-shadow: 0 0 18px rgba(255,45,255,.9), 0 0 22px rgba(255,0,102,.65);
}
#run.warriorMode .quickBtn:nth-child(3){
  background: linear-gradient(135deg, #ffe600, #ff8a00);
  box-shadow: 0 0 18px rgba(255,230,0,.9), 0 0 22px rgba(255,138,0,.65);
}
#run.warriorMode .quickBtn:hover{
  transform: scale(1.07) rotate(-1deg);
}

/* Add button: neon thunder */
#run.warriorMode .addBtn{
  background: linear-gradient(135deg, #00d4ff, #00ffae);
  color:#020003;
  border:none;
  box-shadow:
    0 0 16px rgba(0,212,255,.9),
    0 0 28px rgba(0,255,174,.75);
}

/* Ghost buttons: neon outline */
#run.warriorMode .ghostBtn{
  background: rgba(0,0,0,.28);
  border: 1px solid rgba(255,45,255,.35);
  box-shadow:
    0 0 18px rgba(255,45,255,.25),
    0 0 24px rgba(0,255,174,.12);
}
#run.warriorMode .ghostBtn:hover{
  border-color: rgba(0,255,174,.55);
  box-shadow:
    0 0 18px rgba(0,255,174,.35),
    0 0 28px rgba(255,45,255,.22);
}

/* Inputs: neon frame */
#run.warriorMode input{
  border: 2px solid rgba(0,255,174,.45);
  box-shadow:
    0 0 14px rgba(0,255,174,.22),
    0 0 18px rgba(255,45,255,.14);
}

/* Toggle itself: make it scream */
#run.warriorMode .modeToggleWrap{
  border: 1px solid rgba(0,255,174,.40);
  box-shadow:
    0 0 18px rgba(0,255,174,.22),
    0 0 24px rgba(255,45,255,.18);
}
#run.warriorMode .switch{
  background: linear-gradient(135deg, rgba(255,45,255,.28), rgba(0,255,174,.22));
  border: 1px solid rgba(255,45,255,.35);
}
#run.warriorMode .switch.on .knob{
  filter: drop-shadow(0 0 14px rgba(0,255,174,.9)) drop-shadow(0 0 20px rgba(255,45,255,.65));
}

</style>

<style>
/* MAP BLACK BACKGROUND */
#map, .leaflet-container {
  background: #000 !important;
}
/* Subtle vignette */
#map::after{
  content:"";
  position:absolute; inset:0;
  pointer-events:none;
  box-shadow: inset 0 0 120px rgba(0,0,0,0.6);
}
</style>


<style>
/* High-contrast controls on black */
.leaflet-control-zoom a {
  background:#111 !important;
  color:#eaff00 !important;
  border:1px solid #333 !important;
  box-shadow: 0 0 12px rgba(163,255,18,.35);
}
.leaflet-control-zoom a:hover { background:#000 !important; }
</style>

</head>

<body>
<div id="toast" class="toast"></div>

<!-- LOGIN -->

<section id="auth">
  <div class="loginCard">
    <h1 class="loginTitle">Warrior Half Marathon ‚ö°</h1>
    <div class="loginSub">Enter your login code to track your Warrior progress.</div>

    <div class="fieldWrap">
      <input id="accessCode" placeholder="Login code" autocomplete="one-time-code" />
    </div>

    <div class="warnLine">üîë Your code is <b>case sensitive</b>.</div>

    <button id="loginBtn" onclick="login()" style="width:100%; margin-top:12px;">Continue</button>

    <div class="helpLine">Need your code? Message the organiser.</div>
  </div>
</section>

<!-- SPLASH -->

<section id="splash" style="display:none">
  <div class="splashWrap">
    <div class="brandTitle">Warrior Half Marathon</div>
    <div class="brandTag">walk, run, wrestle ‚Ä¢ WRW</div>

    <div class="spotifyTopBar">
      <div class="spotifyTopText">‚ö° Check out your exclusive Warrior playlist to power the run.</div>
      <button class="spotifyTopBtn" type="button" onclick="openSpotify()">Spotify</button>
    </div>

    <div class="whoRow">
      <span class="pill">‚úÖ Logged in: <span id="whoSplash" class="mono"></span></span>
      <button class="pillBtn" onclick="logoutConfirm()">Log out</button>
    </div>

    <div class="welcomeLine">Welcome <span id="userName"></span> ‚ö°</div>
    <div style="margin-top:12px; width:100%; max-width:320px;">
      <input id="displayNameInput" placeholder="Add name (optional)" />
      <button class="splashBtn" style="margin-top:8px;" onclick="saveDisplayName()">Save name</button>
    </div>

    <div id="splashProgress" class="progressLine">Progress: 0.00 / 21.00 km</div>
    <div class="nextLine">Tap Continue to open the map and log your distance.</div>

    <div class="progressCard" style="margin-top:14px; text-align:left;">
      <div class="progressLabel" style="font-size:14px; font-weight:900; margin-bottom:6px; color:var(--text);">Progress saved on your device</div>
      <div class="progressLabel" style="font-size:13px; line-height:1.55;">
        This app stores your run progress locally on your phone or browser.<br><br>
        We don‚Äôt track your activity, build databases, or collect runner data ‚Äî it simply runs on your device to support your run.<br><br>
        Clearing browser data or switching devices will reset your progress.<br><br>
        When you finish, submit your proof by email as instructed.
      </div>
    </div>


    <button id="startBtn" class="splashBtn" onclick="startRun()">Continue</button>
  </div>
</section>

<!-- RUN -->
<section id="run" style="display:none; justify-content:flex-start;">
  <div class="topBar">
    <div class="topTitle">Warrior Half Marathon</div>
    <div class="topSub">walk, run, wrestle ‚Ä¢ WRW</div>
  </div>

  <div class="spotifyTopBar" style="max-width:900px;">
    <div class="spotifyTopText">‚ö° Need a boost? Hit the Warrior playlist (opens Spotify).</div>
    <button class="spotifyTopBtn" type="button" onclick="openSpotify()">Spotify</button>
  </div>

  <div class="whoRow" style="justify-content:space-between; width:92vw; max-width:900px;">
    <span class="pill">‚úÖ Logged in: <span id="whoRun" class="mono"></span></span>

    <div class="modeToggleWrap" title="Toggle Warrior Mode (logging page only)">
      <div style="display:flex; flex-direction:column; line-height:1.05;">
        <span class="modeLabel">‚ö° Warrior Mode</span>
        <span class="modeHint">Neon hype switch</span>
      </div>
      <div id="modeSwitch" class="switch" onclick="toggleWarriorMode()"><div class="knob"></div></div>
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button class="pillBtn" onclick="logoutConfirm()">Log out</button>
    </div>
  </div>

  <div class="progressCard">
    <div class="progressTop">
      <div class="progressLabel">Progress</div>
      <div class="progressValue"><span id="total">0.00</span> / 21.00 km</div>
    </div>
    <div class="bar"><div id="barFill" class="barFill"></div></div>

    <div class="subRow">
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <span id="savedPill" class="savedPill">‚úÖ Saved</span>
      </div>
      <div class="lastUpdate">Last update: <span id="lastUpdateText">‚Äî</span></div>
    </div>
  </div>

  <div id="mapWrap">
    <div id="map" class="map-locked"></div>

    <div class="mapControls">
      <button class="mapCtrlBtn" id="mapLockBtn" onclick="toggleMapLock()">Unlock map</button>
      <button class="mapCtrlBtn" onclick="fitRoute()">Fit route</button>
      <button class="mapCtrlBtn" onclick="recenter()">Recenter</button>
    </div>

    <div id="mapLoading" class="mapLoading">
      <div class="mapLoadingCard">
        Loading map‚Ä¶ if this takes ages, zoom once (+) and it usually wakes up.
      </div>
    </div>
  </div>

  <div class="controlsCard">
    <div class="btnRow">
      <button class="quickBtn" onclick="logKm(1)">+1 km</button>
      <button class="quickBtn" onclick="logKm(3)">+3 km</button>
      <button class="quickBtn" onclick="logKm(5)">+5 km</button>
      <button class="quickBtn" onclick="logKm(7)">+7 km</button>
      <button class="quickBtn" onclick="logKm(10)">+10 km</button>
    </div>

    <div class="inputRow">
      <input id="input" class="kmInput" type="text" inputmode="decimal" placeholder="Type km (e.g. 1.5)">
      <button class="addBtn" onclick="logFromInput()">Add</button>
    </div>

    <div class="bottomRow">
      <button class="ghostBtn" onclick="undoLast()" id="undoBtn" disabled>Undo</button>
      
    </div>
  </div>

  <div style="height:24px;"></div>
</section>

<!-- FINISH -->
<div class="overlay" id="finishOverlay" role="dialog" aria-modal="true" style="display:none">
  <div class="card finishCard">
    <div class="finishTop">
      <div class="finishIcon">üéâ</div>
    </div>

    <div class="finishTitle">WELL DONE!</div>
    <p class="finishSub">
      <b id="finishUser">You</b> completed <b>Warrior Half Marathon</b>
    </p>

    <div class="finishStats">
      <span class="statPill">üèÅ Total: <b id="finishTotal">0.00</b> km</span>
      <span class="statPill">üïí Completed: <b id="finishWhen">‚Äî</b></span>
    </div>

    <div class="finishNext">
      <div class="finishNextTitle">Next step to claim your medal</div>
      <ol class="finishSteps">
        <li>Tap <b>Send proof</b> to open an email to us.</li>
        <li>Attach a screenshot/activity proof from your tracker (e.g. Strava/Garmin/Apple/Samsung) showing your <b>distance</b> and <b>date</b>.</li>
        <li>Send it ‚Äî this is the <b>only</b> way we can verify your run and count you as a finisher.</li>
      </ol>
    </div>

    <details class="finishHelp">
      <summary>Send Proof not working on PC?</summary>
      <div class="finishHelpBody">
        Some computers don‚Äôt support automatic email links. If the button doesn‚Äôt open your email app, send your proof manually to:
        <div class="copyRow">
          <span class="emailMono" id="proofEmail">Log.walkrunwrestle@gmail.com</span>
          <button class="copyBtn" type="button" onclick="copyProofEmail()">Copy</button>
        </div>
        Include your FULL NAME and FIRST LINE OF YOUR ADDRESS and attach your proof in the email.
      </div>
    </details>

    <div class="finishButtons">
      <button class="primaryBtn" onclick="emailProof()">Send proof</button>
      <button class="secondaryBtn" onclick="closeFinish()">Back to map</button>
    </div>
  </div>
</div>

<script>
/* ===== Config ===== */
const CHALLENGE_KM = 21;
const WRW_EMAIL = "Log.walkrunwrestle@gmail.com";

/* ACCESS */
const ACCESS_CODE = "Walkrunwrestle2026";

/* ===== Storage ===== */
function getData(){ return JSON.parse(localStorage.getItem("warrior_users") || "{}"); }
function saveData(d){ localStorage.setItem("warrior_users", JSON.stringify(d)); }
function getUser(){ return sessionStorage.getItem("warrior_user"); }
function setUser(u){ sessionStorage.setItem("warrior_user", u); }

/* Normalize numeric usernames so "1" works as "01" */
function normalizeUsername(raw){
  const u = String(raw || "").trim();
  if (/^\d+$/.test(u) && u.length < 2) return u.padStart(2,"0");
  return u;
}

/* ===== UI helpers ===== */
function showOnly(id){
  ["auth","splash","run"].forEach(x=>{
    const el = document.getElementById(x);
    if (el) el.style.display = (x===id) ? "flex" : "none";
  });
}
(function bindLoginKeys(){
  const codeEl = document.getElementById("accessCode");
  const btn = document.getElementById("loginBtn");

  function updateLoginButton(){
    if (!btn) return;
    const v = (codeEl?.value || "").trim();
    btn.disabled = !v;
  }

  if (codeEl){
    codeEl.addEventListener("input", updateLoginButton);
    codeEl.addEventListener("keydown", (e)=>{
      if (e.key === "Enter"){
        e.preventDefault();
        if (btn && !btn.disabled) login();
      }
    });
  }

  updateLoginButton();
})();
let toastTimer=null;
function showToast(msg, ms=1300){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove("show"), ms);
}
let savedTimer=null;
function flashSaved(){
  const el=document.getElementById("savedPill");
  el.classList.add("show");
  clearTimeout(savedTimer);
  savedTimer=setTimeout(()=>el.classList.remove("show"), 900);
}
function displayTime(iso){
  if (!iso) return "‚Äî";
  try { return new Date(iso).toLocaleString(); } catch(e){ return "‚Äî"; }
}

/* ===== Spotify button (placeholder) ===== */
function openSpotify(){
  try {
    window.open("https://open.spotify.com/playlist/3XpXjz1aM2hIuoMAGGEg82?si=ifesnmkcTdGK-nf9UdhEJQ&pi=8yBerXKOT4ySg", "_blank");
  } catch (e) {
    // fallback (some webviews block popups unless triggered directly)
    location.href = "https://open.spotify.com/playlist/3XpXjz1aM2hIuoMAGGEg82?si=ifesnmkcTdGK-nf9UdhEJQ&pi=8yBerXKOT4ySg";
  }
}



function getDisplayName(){
  const u = getUser();
  const data = getData();
  return data?.[u]?.displayName || u;
}

function saveDisplayName(){
  const u = getUser();
  const v = document.getElementById("displayNameInput").value.trim();
  if(!v) return alert("Please enter a name");
  const data = getData();
  if(!data[u]) return;
  data[u].displayName = v;
  saveData(data);
  document.getElementById("userName").textContent = v;
  document.getElementById("whoSplash").textContent = v;
  showToast("Name saved", 1200);
}


/* ===== Login / logout ===== */
function login(){
  const codeRaw = (document.getElementById("accessCode")?.value || "").trim();
  if (!codeRaw){ alert("Enter your login code."); return; }
  if (codeRaw !== ACCESS_CODE){ alert("Wrong code (case sensitive)."); return; }

  const u = codeRaw;

  const data = getData();
  if (!data[u]){
    data[u] = {
      displayName: "",
      km: 0,
      history: [],
      emails: [],
      last_update: null,
      finish_at: null
    };
    saveData(data);
  }

  setUser(u);
  showOnly("splash");

  document.getElementById("userName").textContent = getDisplayName();
  document.getElementById("whoSplash").textContent = getDisplayName();

  const saved = Math.min((data[u].km || 0), CHALLENGE_KM);
  document.getElementById("splashProgress").textContent = `Progress: ${saved.toFixed(2)} / 21.00 km`;
  document.getElementById("startBtn").textContent = saved > 0 ? "Continue" : "Start";
}
function logoutConfirm(){ if (confirm("Log out?")) logout(); }
function logout(){
  teardownMap();
  sessionStorage.removeItem("warrior_user");
  location.reload();
}

/* ===== Map + route ===== */
/* A simple lightning bolt-ish loop route */
const START=[24.65, 12.65];
const MAP_ROUTE_KM = 21; // visual route distance (doesn't change challenge km)
const TARGET_ROUTE_METERS = MAP_ROUTE_KM*1000;

function haversineMeters(a,b){
  const R=6371000, toRad=d=>d*Math.PI/180;
  const lat1=toRad(a[0]), lat2=toRad(b[0]);
  const dLat=toRad(b[0]-a[0]), dLng=toRad(b[1]-a[1]);
  const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
  const x=s1*s1+Math.cos(lat1)*Math.cos(lat2)*s2*s2;
  return 2*R*Math.asin(Math.min(1, Math.sqrt(x)));
}
function totalRouteMeters(route){
  let m=0;
  for(let i=1;i<route.length;i++) m+=haversineMeters(route[i-1],route[i]);
  return m;
}
function generateLightningRoute(){
  const route=[];
  const baseLat=START[0], baseLng=START[1];

  // UPRIGHT "W" ROUTE ‚Äî narrower and taller for stronger 3D logo feel
  const pts=[
    [0.90, 0.20],   // left peak (high)
    [0.10, 0.45],   // valley 1
    [0.70, 0.70],   // middle peak
    [0.10, 0.95],   // valley 2
    [0.90, 1.20]    // right peak
  ];

  for (const [dLat,dLng] of pts) route.push([baseLat+dLat, baseLng+dLng]);
  return route;
}
function scaleRouteToMeters(route, targetMeters){
  const current=totalRouteMeters(route);
  if (!current || current<1) return route;
  const scale=targetMeters/current;
  return route.map(pt=>{
    const dLat=pt[0]-START[0];
    const dLng=pt[1]-START[1];
    return [START[0]+dLat*scale, START[1]+dLng*scale];
  });
}
const ROUTE = scaleRouteToMeters(generateLightningRoute(), TARGET_ROUTE_METERS);

let map, redLine, greenLine, marker, distCum=[], totalMeters=0;
let lastLoggedDistance=null;
let mapLocked=true;

function resetMapContainer(){
  // Some Android webviews keep a "ghost" Leaflet instance; recreate the DOM node to be safe.
  const old = document.getElementById("map");
  if (!old) return;
  const cls = old.className || "";
  old.outerHTML = `<div id="map" class="${cls}"></div>`;
}

function teardownMap(){
  try{ if(map){ map.off(); map.remove(); } }catch(e){}
  map=null; redLine=null; greenLine=null; marker=null;
  distCum=[]; totalMeters=0; lastLoggedDistance=null; mapLocked=true;
}
function applyMapLockState(){
  if(!map) return;
  const mapEl=document.getElementById("map");
  if(mapLocked){
    map.scrollWheelZoom.disable(); map.dragging.disable(); map.touchZoom.disable();
    map.doubleClickZoom.disable(); map.boxZoom.disable(); map.keyboard.disable();
    if (map.tap) map.tap.disable();
    document.getElementById("mapLockBtn").textContent="Unlock map";
    mapEl.classList.add("map-locked"); mapEl.classList.remove("map-unlocked");
  }else{
    map.scrollWheelZoom.enable(); map.dragging.enable(); map.touchZoom.enable();
    map.doubleClickZoom.enable(); map.boxZoom.enable(); map.keyboard.enable();
    if (map.tap) map.tap.enable();
    document.getElementById("mapLockBtn").textContent="Lock map";
    mapEl.classList.remove("map-locked"); mapEl.classList.add("map-unlocked");
  }
}
function toggleMapLock(){
  mapLocked=!mapLocked;
  applyMapLockState();
  showToast(mapLocked ? "Map locked üîí" : "Map unlocked üó∫Ô∏è", 1100);
}
function recenter(){ if(map) map.setView(START, 9, {animate:true}); }
function fitRoute(){ if(map && redLine) map.fitBounds(redLine.getBounds(), {padding:[26,26]}); }

function metersForLoggedKm(km){
  const clamped=Math.max(0, Math.min(CHALLENGE_KM, km));
  return (clamped/CHALLENGE_KM)*totalMeters;
}
function pointAtMeters(m){
  if (m<=0) return {pt:ROUTE[0], idx:0};
  if (m>=totalMeters) return {pt:ROUTE[ROUTE.length-1], idx:ROUTE.length-2};
  let i=0;
  while(i<distCum.length-1 && distCum[i+1] < m) i++;
  const A=ROUTE[i], B=ROUTE[i+1];
  const t=(m-distCum[i])/(distCum[i+1]-distCum[i]);
  return {pt:[A[0]+(B[0]-A[0])*t, A[1]+(B[1]-A[1])*t], idx:i};
}
function polyUpToMeters(m){
  const {pt, idx}=pointAtMeters(m);
  const base=ROUTE.slice(0, idx+1);
  base.push(pt);
  return base;
}
function setProgressInstant(km){
  const m=metersForLoggedKm(km);
  const {pt}=pointAtMeters(m);
  greenLine.setLatLngs(polyUpToMeters(m));
  marker.setLatLng(pt);
}
function animateProgress(fromKm,toKm){
  const fromM=metersForLoggedKm(fromKm), toM=metersForLoggedKm(toKm);
  const frames=160; let f=0;
  function step(){
    f++;
    const t=Math.min(1, f/frames);
    const m=fromM+(toM-fromM)*t;
    const {pt}=pointAtMeters(m);
    greenLine.setLatLngs(polyUpToMeters(m));
    marker.setLatLng(pt);
    if(t<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* ===== Progress + logging ===== */
function setProgressUI(km){
  const clamped=Math.max(0, Math.min(CHALLENGE_KM, Number(km||0)));
  document.getElementById("total").textContent=clamped.toFixed(2);
  document.getElementById("barFill").style.width=((clamped/CHALLENGE_KM)*100).toFixed(1)+"%";
  updateUndoButtonState();
}
function updateLastUpdateLabel(){
  const u=getUser();
  const data=getData();
  const iso=data?.[u]?.last_update || null;
  document.getElementById("lastUpdateText").textContent = iso ? displayTime(iso) : "‚Äî";
}
function updateUndoButtonState(){
  const u=getUser();
  const data=getData();
  const hist=data?.[u]?.history;
  const has=Array.isArray(hist) && hist.length>0;
  const btn=document.getElementById("undoBtn");
  btn.disabled=!has;
}


/* =========================
   WARRIOR MODE (run page only)
========================= */
function setWarriorMode(on){
  const run = document.getElementById("run");
  if (!run) return;

  const enabled = !!on;
  run.classList.toggle("warriorMode", enabled);

  const sw = document.getElementById("modeSwitch");
  if (sw) sw.checked = enabled;

  try{ localStorage.setItem("warrior_mode", enabled ? "1" : "0"); }catch(e){}
}

function toggleWarriorMode(){
  const run = document.getElementById("run");
  const enabled = !(run && run.classList.contains("warriorMode"));
  setWarriorMode(enabled);
  showToast(enabled ? "Warrior mode ON ‚ö°" : "Warrior mode OFF", 1100);
}

function loadWarriorModePreference(){
  let on = false;
  try{ on = (localStorage.getItem("warrior_mode") === "1"); }catch(e){}
  setWarriorMode(on);
}

function startRun(){
  const u=getUser() || "";
  showOnly("run");
  loadWarriorModePreference();
  document.getElementById("whoRun").textContent=getDisplayName();

  // Always fully reset map (this app has had WebView map issues before)
  teardownMap();
  resetMapContainer();

  map = L.map("map", { zoomControl:true, preferCanvas:true }).setView(START, 9);
  mapLocked=true;
  applyMapLockState();

  const loadingEl=document.getElementById("mapLoading");
  let hideDone=false;
  function hideLoading(){ if(!loadingEl || hideDone) return; hideDone=true; loadingEl.style.display="none"; }

  // Primary tiles (fast + clean). If tiles fail (common in some WebViews), fallback to OSM standard.
  let tileErrorCount = 0;
  let tiles = L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png",
    { maxZoom:19, subdomains:"abcd", attribution:"&copy; OpenStreetMap contributors &copy; CARTO", crossOrigin:true }
  ).addTo(map);

  tiles.once("load", hideLoading);
  tiles.on("tileerror", ()=>{
    tileErrorCount++;
    // After a few failures, swap to OpenStreetMap tiles which tend to work more reliably.
    if (tileErrorCount === 3){
      try{ map.removeLayer(tiles); }catch(e){}
      tiles = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        { maxZoom:19, subdomains:"abc", attribution:"&copy; OpenStreetMap contributors", crossOrigin:true }
      ).addTo(map);
      tiles.once("load", hideLoading);
    }
  });

  // If the container was hidden, Leaflet sometimes renders blank until invalidated.
  map.whenReady(()=>{
    setTimeout(()=>{ try{ map.invalidateSize(); }catch(e){} }, 0);
    setTimeout(()=>{ try{ map.invalidateSize(); }catch(e){} }, 250);
    setTimeout(()=>{ try{ map.invalidateSize(); }catch(e){} }, 900);
  });
  setTimeout(hideLoading, 4500);

  redLine=L.polyline(ROUTE, {color:"rgba(163,255,18,.75)", weight:4, opacity:0.92}).addTo(map);
  
  // --- NEON GLOW LAYERS (behind main route) ---
  // Outer soft glow
  const glowOuter = L.polyline(ROUTE, {
    color: "rgba(124, 58, 237, 0.35)", // purple glow
    weight: 22,
    opacity: 0.6,
    lineCap: "round",
    lineJoin: "round"
  }).addTo(map);

  // Inner bright glow
  const glowInner = L.polyline(ROUTE, {
    color: "rgba(163, 255, 18, 0.55)", // neon lime halo
    weight: 14,
    opacity: 0.9,
    lineCap: "round",
    lineJoin: "round"
  }).addTo(map);

  // Ensure order: shadow -> outer glow -> inner glow -> main route
  try { redShadow && redShadow.bringToBack(); } catch(e) {}
  try { glowOuter.bringToBack(); } catch(e) {}
  try { glowInner.bringToBack(); } catch(e) {}
  try { redLine.bringToFront(); } catch(e) {}
greenLine=L.polyline([], {color:"rgba(124,58,237,.95)", weight:6, opacity:0.95}).addTo(map);

  marker=L.circleMarker(ROUTE[0], {
    radius:6,
    color:"rgba(163,255,18,.85)",
    weight:2,
    fillColor:"rgba(163,255,18,.55)",
    fillOpacity:1
  }).addTo(map);

  fitRoute();

  distCum=[0]; totalMeters=0;
  for(let i=1;i<ROUTE.length;i++){
    totalMeters += map.distance(ROUTE[i-1], ROUTE[i]);
    distCum.push(totalMeters);
  }

  const data=getData();
  const saved=Math.min((data[u]?.km||0), CHALLENGE_KM);
  setProgressUI(saved);
  setProgressInstant(saved);
  updateLastUpdateLabel();

  if(saved>=CHALLENGE_KM){
    if(!data[u].finish_at){
      data[u].finish_at=new Date().toISOString();
      data[u].last_update=data[u].finish_at;
      saveData(data);
      updateLastUpdateLabel();
    }
    showFinish();
  }
}

function confirmAdd(km){
  return confirm(`Add ${km.toFixed(2)} km to your run?`);
}
function logKm(km){
  km=Number(km);
  if(!km || km<=0) return;
  if(!confirmAdd(km)) return;
  doLog(km);
}
function parseKmInput(raw){
  if(raw==null) return NaN;
  const s=String(raw).trim().replace(",",".");
  if(!s) return NaN;
  return Number(s);
}
function logFromInput(){
  const v=parseKmInput(document.getElementById("input").value);
  if(!v || v<=0) return;
  logKm(v);
}
function doLog(addKm){
  const data=getData();
  const u=getUser();
  if(!data[u]) return alert("User not found.");

  const before=Math.min(Number(data[u].km||0), CHALLENGE_KM);
  const after=Math.min(before+addKm, CHALLENGE_KM);

  data[u].km=after;
  data[u].history=Array.isArray(data[u].history)?data[u].history:[];
  const nowISO=new Date().toISOString();
  const nowLocal=new Date().toLocaleString();
  data[u].history.push({atISO:nowISO, atLocal:nowLocal, km:addKm});
  data[u].last_update=nowISO;
  if(after>=CHALLENGE_KM && !data[u].finish_at) data[u].finish_at=nowISO;

  saveData(data);
  lastLoggedDistance=addKm;

  setProgressUI(after);
  animateProgress(before, after);
  flashSaved();
  updateLastUpdateLabel();

  showToast(`Added +${addKm.toFixed(2)} km ‚ö°`, 1200);
  document.getElementById("input").value="";
  updateUndoButtonState();

  if(after>=CHALLENGE_KM) setTimeout(showFinish, 450);
}
function undoLast(){
  const u=getUser();
  const data=getData();
  if(!data[u]) return;

  const hist=Array.isArray(data[u].history)?data[u].history:[];
  if(!hist.length){ showToast("Nothing to undo.", 1100); updateUndoButtonState(); return; }

  const last=hist.at(-1);
  const lastKm=Number(last.km||0);
  if(!confirm(`Undo last log (${lastKm.toFixed(2)} km)?`)) return;

  const before=Math.min(Number(data[u].km||0), CHALLENGE_KM);
  const after=Math.max(0, before-lastKm);

  hist.pop();
  data[u].history=hist;
  data[u].km=after;
  if(after<CHALLENGE_KM) data[u].finish_at=null;
  data[u].last_update=new Date().toISOString();
  saveData(data);

  lastLoggedDistance=null;

  setProgressUI(after);
  setProgressInstant(after);
  updateLastUpdateLabel();
  closeFinish();

  showToast(`Undone (-${lastKm.toFixed(2)} km)`, 1200);
  updateUndoButtonState();
}

/* Email */
function recordEmailAttempt(){
  const u=getUser();
  const data=getData();
  if(!data[u]) return;
  data[u].emails=Array.isArray(data[u].emails)?data[u].emails:[];
  const nowISO=new Date().toISOString();
  const nowLocal=new Date().toLocaleString();
  data[u].emails.push({atISO:nowISO, atLocal:nowLocal});
  data[u].last_update=nowISO;
  saveData(data);
  updateLastUpdateLabel();
}
function emailProof(){
  const u=getUser() || "unknown";
  const logged=(typeof lastLoggedDistance==="number") ? Number(lastLoggedDistance).toFixed(2) : "N/A";
  const subject=`Warrior Half Marathon Completed`;
  const body=[
    `Congrats on finishing Warrior Half Marathon!`,
    "",
    "Please fill in the details below:",
    "",
    "Forename:",
    "Surname:",
    "First line of address:",
    "",
    "Then attach your proof of completion.",
    "",
    "Medals are dispatched on the last Friday of each month.",
    "Proofs sent after the last Wednesday of the month will be dispatched in the following month."
  ].join("\n");

  recordEmailAttempt();

  const mailto =
    `mailto:${encodeURIComponent(WRW_EMAIL)}` +
    `?subject=${encodeURIComponent(subject)}` +
    `&body=${encodeURIComponent(body)}`;

  window.location.href=mailto;
}

function copyProofEmail(){
  const email = (typeof WRW_EMAIL !== "undefined" && WRW_EMAIL) ? WRW_EMAIL : "logwalkrunwrestle@gmail.com";
  try{
    navigator.clipboard.writeText(email).then(()=>showToast("Email copied ‚úÖ", 1100)).catch(()=>fallbackCopy(email));
  }catch(e){ fallbackCopy(email); }
  function fallbackCopy(text){
    const ta=document.createElement("textarea");
    ta.value=text; ta.setAttribute("readonly","");
    ta.style.position="fixed"; ta.style.left="-9999px";
    document.body.appendChild(ta); ta.select();
    try{ document.execCommand("copy"); showToast("Email copied ‚úÖ", 1100); }
    catch(e){ showToast("Copy failed ‚Äî long press to copy", 1400); }
    document.body.removeChild(ta);
  }
}

/* Finish */
function showFinish(){
  try{ const pe=document.getElementById("proofEmail"); if(pe && typeof WRW_EMAIL!=="undefined") pe.textContent=WRW_EMAIL; }catch(e){}
  const u=getUser() || "You";
  const data=getData();
  const obj=data[u] || {};
  const total=Math.min(Number(obj.km||0), CHALLENGE_KM).toFixed(2);
  const whenISO=obj.finish_at || new Date().toISOString();
  let whenNice="‚Äî"; try{ whenNice=new Date(whenISO).toLocaleString(); }catch(e){}
  document.getElementById("finishUser").textContent=getDisplayName();
  document.getElementById("finishTotal").textContent=total;
  document.getElementById("finishWhen").textContent=whenNice;
  document.getElementById("finishOverlay").style.display="flex";
}
function closeFinish(){ document.getElementById("finishOverlay").style.display="none"; }

/* Boot */
showOnly("auth");
</script>
</body>
</html>
